''' Tests for the `utils` submodule '''

__author__ = 'Kevin Tran'
__email__ = 'ktran@andrew.cmu.edu'

# Things we're testing
from ..utils import find_adsorption_sites, encode_atoms_to_hex, decode_hex_to_atoms, encode_atoms_to_trajhex, decode_trajhex_to_atoms

# Things we need to do the tests
import numpy as np
import numpy.testing as npt
from .baselines import get_standard_atoms
from .learning_tests.pymatgen_test import _get_sites_for_standard_structure


def test_find_adsorption_sites():
    '''
    Check out `.learning_tests.pymatgen_test._get_sites_for_standard_structure`
    to see what pymatgen gives us. Our `gaspy.utils.find_adsorption_sites` simply gives us
    the value of that object when the key is 'all'.
    '''
    standard_sites = _get_sites_for_standard_structure()['all']
    sites = find_adsorption_sites(get_standard_atoms())
    npt.assert_allclose(np.array(sites), np.array(standard_sites), rtol=1e-5, atol=-1e-7)


def test_encode_atoms_to_hex():
    atoms = get_standard_atoms()
    atoms_hex = encode_atoms_to_hex(atoms)
    standard_atoms_hex = _get_standard_atoms_hex()
    assert atoms_hex == standard_atoms_hex


def test_decode_hex_to_atoms():
    atoms_hex = _get_standard_atoms_hex()
    atoms = decode_hex_to_atoms(atoms_hex)
    standard_atoms = get_standard_atoms()
    assert atoms == standard_atoms

def test_encode_atoms_to_trajhex():
    atoms = get_standard_atoms()
    atoms_trajhex = encode_atoms_to_trajhex(atoms)
    atoms_out = decode_trajhex_to_atoms(atoms_trajhex)
    assert atoms==atoms_out

def test_decode_trajhex_to_atoms():
    trajhex = '2d206f6620556c6d4153452d5472616a6563746f72792020030000000000000001000000000000003000000000000000380f0000000000001a000000000000001a000000000000001a000000000000001a000000000000004a000000000000004a000000000000004a000000000000004a00000000000000070000000000000007000000000000000700000000000000070000000000000007000000000000000700000000000000070000000000000007000000000000001a000000000000001a000000000000001a000000000000001a000000000000004a000000000000004a000000000000004a000000000000004a00000000000000070000000000000007000000000000000700000000000000070000000000000007000000000000000700000000000000070000000000000007000000000000001a000000000000001a000000000000001a000000000000001a000000000000004a000000000000004a000000000000004a000000000000004a000000000000000700000000000000070000000000000007000000000000000700000000000000070000000000000007000000000000000700000000000000070000000000000062f816f1ffffc73c27ad338401631ac0278698037f663440bea070d43ec7034026ad338401631ac0135d9c7f16f93240380e13050000c83c13f025dfc337f2bffd33a0fbad8b3140bea070d43ec7034013f025dfc337f2bf115d9c7f16f932403cecafe6ffffafbcdc6234e5c4a622c0278698037f663440bea070d43ec70340dc6234e5c4a622c03baf9487e7d3354044109c0a0000c83c2b29fd7bf2f00ec0268698037f663440c2a070d43ec703402b29fd7bf2f00ec0125d9c7f16f93240a82b9670fe5efa3f462e6013933c25c0278698037f66344048db5d065f7b1040462e6013933c25c03baf9487e7d33540ae2b9670fe5eea3f6a2b569a15a414c0145d9c7f16f93240ab2b9670fe5e0a406a2b569a15a414c0288698037f663440a72b9670fe5efa3f729708b7f61020c0278698037f66344049db5d065f7b1040729708b7f61020c03baf9487e7d33540ad2b9670fe5eea3f83fb4dc3b99904c0125d9c7f16f93240a72b9670fe5e0a4083fb4dc3b99904c0278698037f6634401a5c97f9ffffc73c26ad338401631ac0fe33a0fbad8b3140bea070d43ec7034026ad338401631ac0ea0aa477451e3040ef71930d0000c83c15f025dfc337f2bfaac34fe7b9612d40bea070d43ec7034014f025dfc337f2bfeb0aa477451e30408c8d36000000dc3cdc6234e5c4a622c0fd33a0fbad8b3140bea070d43ec70340dc6234e5c4a622c0135d9c7f16f93240fe731c130000c83c2b29fd7bf2f00ec0fe33a0fbad8b3140c2a070d43ec703402c29fd7bf2f00ec0ea0aa477451e3040ab2b9670fe5efa3f462e6013933c25c0fe33a0fbad8b31404adb5d065f7b1040462e6013933c25c0145d9c7f16f93240b62b9670fe5eea3f6a2b569a15a414c0e90aa477451e3040ab2b9670fe5e0a406a2b569a15a414c0ff33a0fbad8b3140af2b9670fe5efa3f729708b7f61020c0ff33a0fbad8b31404adb5d065f7b1040729708b7f61020c0125d9c7f16f93240b62b9670fe5eea3f84fb4dc3b99904c0ea0aa477451e3040ab2b9670fe5e0a4083fb4dc3b99904c0fe33a0fbad8b31409865d2daffffafbc26ad338401631ac0acc34fe7b9612d40c2a070d43ec7034026ad338401631ac0867157dfe8862a406e1770070000dc3c17f025dfc337f2bf5a1f5fd717ac2740bea070d43ec7034016f025dfc337f2bf847157dfe8862a4066bf76040000dc3cdc6234e5c4a622c0aec34fe7b9612d40bea070d43ec70340dc6234e5c4a622c0ea0aa477451e30400e5a0ef4ffffc73c2c29fd7bf2f00ec0aac34fe7b9612d40bea070d43ec703402d29fd7bf2f00ec0867157dfe8862a40ab2b9670fe5efa3f462e6013933c25c0adc34fe7b9612d404adb5d065f7b1040462e6013933c25c0ea0aa477451e3040af2b9670fe5eea3f6b2b569a15a414c0847157dfe8862a40ac2b9670fe5e0a406a2b569a15a414c0a9c34fe7b9612d40ab2b9670fe5efa3f729708b7f61020c0acc34fe7b9612d4049db5d065f7b1040729708b7f61020c0ea0aa477451e3040be2b9670fe5eea3f85fb4dc3b99904c0807157dfe8862a40ab2b9670fe5e0a4084fb4dc3b99904c0aac34fe7b9612d40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c7030000000000007b2263656c6c223a205b5b342e3934343537353631343333323434382c20312e36333135353732383831333632363932652d33312c20312e33333232363736323935353031383738652d31355d2c205b2d322e323230343436303439323530333133652d31362c202d31302e39313631343138382c20322e383534373532303631393633323939335d2c205b2d312e37373633353638333934303032353035652d31352c20332e383435363639323732353436393236652d31352c2033312e34303232373236383135393632385d5d2c2022746167732e223a207b226e646172726179223a205b5b34385d2c2022696e743634222c20313539325d7d2c2022706f736974696f6e732e223a207b226e646172726179223a205b5b34382c20335d2c2022666c6f61743634222c203434305d7d2c20226d61676d6f6d732e223a207b226e646172726179223a205b5b34385d2c2022666c6f61743634222c20333132385d7d2c2022636861726765732e223a207b226e646172726179223a205b5b34385d2c2022666c6f61743634222c20333531325d7d2c202263616c63756c61746f722e223a207b226e616d65223a2022756e6b6e6f776e227d2c20226e756d626572732e223a207b226e646172726179223a205b5b34385d2c2022696e743634222c2035365d7d2c20226d6f6d656e74612e223a207b226e646172726179223a205b5b34382c20335d2c2022666c6f61743634222c20313937365d7d2c202276657273696f6e223a20312c2022706263223a205b747275652c20747275652c20747275655d2c20226173655f76657273696f6e223a2022332e31342e31222c2022636f6e73747261696e7473223a20225b7b5c226e616d655c223a205c2246697841746f6d735c222c205c226b77617267735c223a207b5c22696e64696365735c223a205b302c20312c20322c20332c20342c20352c20362c20372c20382c20392c2031302c2031312c2031322c2031332c2031342c2031352c2031362c2031392c2032302c2032312c2032322c2032332c2032342c2032352c2032362c2032372c2032382c2032392c2033302c2033315d7d7d2c207b5c226e616d655c223a205c2246697841746f6d735c222c205c226b77617267735c223a207b5c22696e64696365735c223a205b31362c2031372c2031382c2031392c2032302c2032312c2032322c2032332c2032342c2032352c2032362c2032372c2032382c2033302c2033322c2033332c2033342c2033352c2033362c2033372c2033382c2033392c2034302c2034312c2034322c2034332c2034342c2034352c2034362c2034375d7d7d5d227d'
    atoms = decode_trajhex_to_atoms(trajhex)

def _get_standard_atoms_hex():
    '''
    This is the hex string that is supposed to be created when encoding our standard atoms object.
    '''
    standard_atoms_hex = '8003636173652e61746f6d730a41746f6d730a7100298171017d710228580600000061727261797371037d71042858070000006e756d6265727371056364696c6c2e5f64696c6c0a5f6765745f617474720a71066364696c6c2e5f64696c6c0a5f696d706f72745f6d6f64756c650a710758150000006e756d70792e636f72652e6d756c74696172726179710885710952710a580c0000005f7265636f6e737472756374710b86710c52710d636e756d70790a6e6461727261790a710e4b0085710f4301627110877111527112284b014b01857113636e756d70790a64747970650a71145802000000693871154b004b01877116527117284b0358010000003c71184e4e4e4affffffff4affffffff4b00747119628943081d00000000000000711a74711b625809000000706f736974696f6e73711c680d680e4b0085711d681087711e52711f284b014b014b0386712068145802000000663871214b004b01877122527123284b0368184e4e4e4affffffff4affffffff4b00747124628943180000000000000000000000000000000000000000000000007125747126627558050000005f63656c6c7127680d680e4b00857128681087712952712a284b014b034b0386712b68238943480000000000000000e17a14ae47e1fc3fe17a14ae47e1fc3fe17a14ae47e1fc3f0000000000000000e17a14ae47e1fc3fe17a14ae47e1fc3fe17a14ae47e1fc3f0000000000000000712c74712d6258090000005f63656c6c64697370712e680d680e4b0085712f6810877130527131284b014b034b018671326823894318000000000000000000000000000000000000000000000000713374713462580c0000005f636f6e73747261696e747371355d713658040000005f7062637137680d680e4b00857138681087713952713a284b014b0385713b681458020000006231713c4b004b0187713d52713e284b0358010000007c713f4e4e4e4affffffff4affffffff4b00747140628943030101017141747142625804000000696e666f71437d714458050000005f63616c6371454e75622e'
    return standard_atoms_hex
