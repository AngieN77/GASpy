'''
Tests for the `gasdb` submodule. Since this submodule deals with Mongo databases so much,
we created and work with a collection with the tag 'for_unit_testing'. We assume that
this collection has only two very specific objects with specific object IDs, as
specified in the `get_expected_collection_documents` function. We also assume that
these documents have the same exact JSON architecture.
'''

__author__ = 'Kevin Tran'
__email__ = 'ktran@andrew.cmu.edu'

# Things we're testing
from ..gasdb import get_adsorption_docs, _clean_up_aggregated_docs

# Things we need to do the tests
import copy
import datetime
from bson.objectid import ObjectId
import random


def get_expected_collection_documents():
    docs = [{'_id': ObjectId("59a015cbd39525770b3b122d"),
             'atoms': {'atoms': [{'charge': 0,
                                  'index': 0,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [0, -2.3810709569494546, -15.112772683579223],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 1,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [2.382858475, -1.2821151425, -17.227083539864434],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 2,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [-1.6288806394297046, -0.2890668595739811, -11.205293519461074],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 3,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [0.7083451902878249, -3.748482245372849, -11.358829330718224],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 4,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [0, -0.0368260393842104, -16.579819352880907],
                                  'symbol': 'Au',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 5,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [2.382858475, -4.066330794934755, -18.674235859166117],
                                  'symbol': 'Au',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 6,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [0, -2.5274042456157897, -17.87434772684796],
                                  'symbol': 'Au',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 7,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [2.382858475, -3.6263600600652444, -15.760036870562748],
                                  'symbol': 'Au',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 8,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [-1.682937833193368, -2.8846158840058855, -10.73977035471658],
                                  'symbol': 'Au',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 9,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [2.382858475, -1.135781853833665, -14.465508496595698],
                                  'symbol': 'Au',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 10,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [0.067410399057377, -4.489805579957833, -13.686811963488845],
                                  'symbol': 'Au',
                                  'tag': 0},
                                 {'charge': 0,
                                  'index': 11,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [0.7436529574552899, -1.1999910007237562, -10.7481507656501],
                                  'symbol': 'Au',
                                  'tag': 1},
                                 {'charge': 0,
                                  'index': 12,
                                  'magmom': 0,
                                  'momentum': [0, 0, 0],
                                  'position': [3.1725134208013857, -0.44899882557233367, -13.01127293099305],
                                  'symbol': 'H',
                                  'tag': 1}],
                       'cell': [[4.76571695, 0, 0],
                                [0, -5.12846057, 0.01989435],
                                [0, 0, -29.54066953]],
                       'chemical_symbols': ['H', 'Au', 'Al'],
                       'constraints': [{'kwargs': {'indices': [0, 1, 4, 5, 6, 7, 9]},
                                        'name': 'FixAtoms'}],
                       'info': {},
                       'mass': 1684.6667059999997,
                       'natoms': 13,
                       'pbc': [True, True, True],
                       'spacegroup': 'P1 (1)',
                       'symbol_counts': {'Al': 4, 'Au': 8, 'H': 1},
                       'volume': 721.9973437444861},
             'calculator': {'class': 'SinglePointCalculator',
                            'module': 'ase.calculators.singlepoint'},
             'ctime': 'ISODate("2017-08-25T12:19:23.067Z")',
             'initial_configuration': {'atoms': {'atoms': [{'charge': 0,
                                                            'index': 0,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [0, -2.3810709569494546, -15.112772683579223],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 1,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [2.382858475, -1.2821151425, -17.227083539864434],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 2,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [4.763816810994865, -0.6613405815197442, -11.183692317515423],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 3,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [2.3819905426290657, -4.320481505125399, -12.178457259617415],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 4,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [0, -0.0368260393842104, -16.579819352880907],
                                                            'symbol': 'Au',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 5,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [2.382858475, -4.066330794934755, -18.674235859166117],
                                                            'symbol': 'Au',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 6,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [0, -2.5274042456157897, -17.87434772684796],
                                                            'symbol': 'Au',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 7,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [2.382858475, -3.6263600600652444, -15.760036870562748],
                                                            'symbol': 'Au',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 8,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [4.76538811553045, -3.227959190607193, -11.477152820966383],
                                                            'symbol': 'Au',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 9,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [2.382858475, -1.135781853833665, -14.465508496595698],
                                                            'symbol': 'Au',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 10,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [0.0002492946536545, -4.884508316498858, -13.746600761647906],
                                                            'symbol': 'Au',
                                                            'tag': 0},
                                                           {'charge': 0,
                                                            'index': 11,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [2.3820334817387856, -1.6485714464827892, -11.252648788460904],
                                                            'symbol': 'Au',
                                                            'tag': 1},
                                                           {'charge': 0,
                                                            'index': 12,
                                                            'magmom': 0,
                                                            'momentum': [0, 0, 0],
                                                            'position': [3.574412383655412, -0.44591477452395845, -12.616001786491829],
                                                            'symbol': 'H',
                                                            'tag': 1}],
                                                 'cell': [[4.76571695, 0, 0],
                                                          [0, -5.12846057, 0.01989435],
                                                          [0, 0, -29.54066953]],
                                                 'chemical_symbols': ['H', 'Au', 'Al'],
                                                 'constraints': [{'kwargs': {'indices': [0, 1, 4, 5, 6, 7, 9]},
                                                                  'name': 'FixAtoms'}],
                                                 'info': {},
                                                 'mass': 1684.6667059999997,
                                                 'natoms': 13,
                                                 'pbc': [True, True, True],
                                                 'spacegroup': 'P1 (1)',
                                                 'symbol_counts': {'Al': 4,
                                                                   'Au': 8,
                                                                   'H': 1},
                                                 'volume': 721.9973437444861},
                                       'calculator': {'class': 'SinglePointCalculator',
                                                      'module': 'ase.calculators.singlepoint'},
                                       'ctime': 'ISODate("2017-08-22T20:37:05.206Z")',
                                       'inserted-hash': '4d32f37e58acd06025b0b0903387b46b59aa57ea',
                                       'mtime': 'ISODate("2017-08-22T20:37:05.206Z")',
                                       'results': {'energy': -38.35199891,
                                                   'fmax': 0.93097406,
                                                   'fmax_unconstrained': 0.93097406,
                                                   'forces': [[0, 0, 0],
                                                              [0, 0, 0],
                                                              [0.37908202, 0.02513182, 0.62418626],
                                                              [-0.57845753, 0.93097406, 0.4936876],
                                                              [0, 0, 0],
                                                              [0, 0, 0],
                                                              [0, 0, 0],
                                                              [0, 0, 0],
                                                              [0.18427365, 0.07420695, 0.25800188],
                                                              [0, 0, 0],
                                                              [0.58040085, 0.30026758, -0.66977818],
                                                              [-0.36824192, -0.31999965, 0.16909147],
                                                              [0.05389424, -0.77815295, -0.5233196]]},
                                       'user': 'ktran'},
             'inserted-hash': 'f10305e044fdfb261b21387a63dcacfabf0271ce',
             'mtime': 'ISODate("2017-08-25T12:19:23.067Z")',
             'processed_data': {'FW_info': {'adslab_calculation_date': 'ISODate("2017-05-16T08:56:53.388Z")',
                                            'bulk': 26197,
                                            'slab': 26555,
                                            'slab+adsorbate': 27953},
                                'calculation_info': {'adsorbate_names': ['CO'],
                                                     'adsorbates': [{'adsorption_site': '[  3.57  -4.6  -10.96]',
                                                                     'atoms': '63636f70795f7265670a5f7265636f6e7374727563746f720a70310a28636173652e61746f6d730a41746f6d730a70320a635f5f6275696c74696e5f5f0a6f626a6563740a70330a4e745270340a286470350a5327696e666f270a70360a286470370a7353275f63656c6c64697370270a70380a636e756d70792e636f72652e6d756c746961727261790a5f7265636f6e7374727563740a70390a28636e756d70790a6e6461727261790a7031300a2849300a74532762270a74527031310a2849310a2849330a49310a74636e756d70790a64747970650a7031320a2853276638270a49300a49310a74527031330a2849330a53273c270a4e4e4e492d310a492d310a49300a74624930300a53275c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c783030270a74627353275f63616c63270a7031340a4e735327617272617973270a7031350a28647031360a5327706f736974696f6e73270a7031370a67390a286731300a2849300a74532762270a74527031380a2849310a2849320a49330a746731330a4930300a53275c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830303333333333335c7866333f270a74627353276e756d62657273270a7031390a67390a286731300a2849300a74532762270a74527032300a2849310a2849320a746731320a2853276938270a49300a49310a74527032310a2849330a53273c270a4e4e4e492d310a492d310a49300a74624930300a53275c7830365c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830385c7830305c7830305c7830305c7830305c7830305c7830305c783030270a7462737353275f706263270a7032320a67390a286731300a2849300a74532762270a74527032330a2849310a2849330a746731320a2853276231270a49300a49310a74527032340a2849330a53277c270a4e4e4e492d310a492d310a49300a74624930300a53275c7830305c7830305c783030270a74627353275f63656c6c270a7032350a67390a286731300a2849300a74532762270a74527032360a2849310a2849330a49330a746731330a4930300a53275c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c783030270a74627353275f636f6e73747261696e7473270a7032370a286c7032380a73622e',
                                                                     'name': 'CO'}],
                                                     'formula': 'HAl4Au8',
                                                     'miller': [1, 1, 2],
                                                     'mpid': 'mp-1018179',
                                                     'num_slab_atoms': 0,
                                                     'relaxed': True,
                                                     'shift': 0.07726067999999997,
                                                     'slabrepeat': '(1, 1)',
                                                     'top': False,
                                                     'type': 'slab+adsorbate'},
                                'fp_final': {'coordination': 'Al-Al-Al-Al-Au',
                                             'natoms': 12,
                                             'neighborcoord': ['Al:Al-Al-Au-Au-Au',
                                                               'Al:Al-Al-Au-Au-Au-Au',
                                                               'Al:Al-Al-Au-Au-Au-Au',
                                                               'Au:Al-Al-Al-Al',
                                                               'Al:Al-Al-Au-Au-Au'],
                                             'nextnearestcoordination': 'Au-Au-Au-Au-Au-Au-Au-Au-Au'},
                                'fp_init': {'coordination': 'Al-Al',
                                            'natoms': 12,
                                            'neighborcoord': ['Al:Al-Al-Au-Au-Au',
                                                              'Al:Al-Al-Au-Au-Au'],
                                            'nextnearestcoordination': 'Au-Au-Au-Au-Au-Au-Au-Au-Au-Au'},
                                'movement_data': {'max_adsorbate_movement': 1.7720139428596056,
                                                  'max_bare_slab_movement': 0.0018229617763855408,
                                                  'max_surface_movement': 1.9493747357556674},
                                'vasp_settings': {'ediffg': -0.03,
                                                  'encut': 350,
                                                  'gga': 'RP',
                                                  'ibrion': 2,
                                                  'isif': 0,
                                                  'isym': 0,
                                                  'kpts': [4, 4, 1],
                                                  'lreal': 'Auto',
                                                  'nsw': 200,
                                                  'pp': 'PBE',
                                                  'pp_version': '5.4'}},
             'results': {'energy': 11.503626990000003,
                         'fmax': 0.02016741,
                         'fmax_unconstrained': 0.02016741,
                         'forces': [[0, 0, 0],
                                    [0, 0, 0],
                                    [-0.01855833, -0.00332462, 0.00148069],
                                    [-0.00573565, -0.00795858, 0.0077236],
                                    [0, 0, 0],
                                    [0, 0, 0],
                                    [0, 0, 0],
                                    [0, 0, 0],
                                    [0.00162812, 0.0096445, 0.01504826],
                                    [0, 0, 0],
                                    [-7.528e-05, 0.01119988, 0.00147697],
                                    [0.00182382, -0.00933883, 0.01043087],
                                    [0.00139348, 0.00670896, -0.02016741]]},
             'user': 'zulissi'},
            {'_id': ObjectId('59a015cbd3952577173b122d'),
             'atoms': {'atoms': [{'charge': 0.0,
                                  'index': 0,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [2.255853084172987,
                                               2.516116542704956,
                                               16.133640236827002],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 1,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [3.7010598050973535,
                                               0.9709846952271831,
                                               18.1213042618302],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 2,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [0.7468253486278252,
                                               3.8805490781369687,
                                               18.0458538221432],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 3,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [2.22670108, 2.507955705, 12.3451371875],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 4,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [3.8052628769625443,
                                               1.106421676686956,
                                               14.2443890625],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 5,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [0.6481392830374559,
                                               3.9094897333130447,
                                               14.2443890625],
                                  'symbol': 'Al',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 6,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [-0.0008795216939955996,
                                               -0.025080058641141004,
                                               16.1812215103207],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 7,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [2.524903340499153,
                                               -0.005745525883698601,
                                               16.1109367318534],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 8,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [-0.3117082060863432,
                                               2.485934650091362,
                                               16.1486267015821],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 9,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [3.3157911029590785,
                                               3.5268928142614677,
                                               18.0734810996177],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 10,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [1.1889326944421381,
                                               1.4039621808675113,
                                               17.911033376604298],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 11,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [0.0, 0.0, 12.3451371875],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 12,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [2.52571834, 0.0, 12.3451371875],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 13,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [-0.29901726, 2.507955705, 12.3451371875],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 14,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [3.2199814848672896,
                                               3.6266973629739696,
                                               14.2443890625],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 15,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [1.2334206751327104,
                                               1.3892140470260306,
                                               14.2443890625],
                                  'symbol': 'Ni',
                                  'tag': 0},
                                 {'charge': 0.0,
                                  'index': 16,
                                  'magmom': 0.0,
                                  'momentum': [0.0, 0.0, 0.0],
                                  'position': [3.1685748301715413,
                                               4.477022954937523,
                                               19.3341175844769],
                                  'symbol': 'H',
                                  'tag': 1}],
                       'cell': [[5.05143668, 0.0, 0.0],
                                [-0.59803452, 5.01591141, 0.0],
                                [0.0, 0.0, 30.38803]],
                       'chemical_symbols': ['Ni', 'Al', 'H'],
                       'constraints': [{'kwargs': {'indices': [3,
                                                               4,
                                                               5,
                                                               11,
                                                               12,
                                                               13,
                                                               14,
                                                               15]},
                                        'name': 'FixAtoms'}],
                       'info': {},
                       'mass': 749.831231,
                       'natoms': 17,
                       'pbc': [True, True, True],
                       'spacegroup': 'P1 (1)',
                       'symbol_counts': {'Al': 6, 'H': 1, 'Ni': 10},
                       'volume': 769.958499375382},
             'calculator': {'class': 'SinglePointCalculator',
                            'module': 'ase.calculators.singlepoint'},
             'ctime': datetime.datetime(2017, 8, 25, 12, 19, 23, 382000),
             'initial_configuration': {'atoms': {'atoms': [{'charge': 0.0,
                                                            'index': 0,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [2.226791042792573,
                                                                         2.508059534366187,
                                                                         16.1260225654666],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 1,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [3.7746520080323998,
                                                                         1.1335124135759094,
                                                                         18.0788524878005],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 2,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [0.6786902272386287,
                                                                         3.8823351438718414,
                                                                         18.0788555266035],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 3,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [2.22670108,
                                                                         2.507955705,
                                                                         12.3451371875],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 4,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [3.8052628769625443,
                                                                         1.106421676686956,
                                                                         14.2443890625],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 5,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [0.6481392830374559,
                                                                         3.9094897333130447,
                                                                         14.2443890625],
                                                            'symbol': 'Al',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 6,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [4.453367872872309,
                                                                         5.015875295437848,
                                                                         16.215697641996602],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 7,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [2.525710456138493,
                                                                         5.25667515768e-05,
                                                                         16.1231876661479],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 8,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [-0.2989659685793268,
                                                                         2.5079576612054497,
                                                                         16.1231888816691],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 9,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [3.2047040551995503,
                                                                         3.60945963166325,
                                                                         17.9864048074133],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 10,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [1.2486284617285488,
                                                                         1.4063783453937082,
                                                                         17.9861085241208],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 11,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [0.0,
                                                                         0.0,
                                                                         12.3451371875],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 12,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [2.52571834,
                                                                         0.0,
                                                                         12.3451371875],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 13,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [-0.29901726,
                                                                         2.507955705,
                                                                         12.3451371875],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 14,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [3.2199814848672896,
                                                                         3.6266973629739696,
                                                                         14.2443890625],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 15,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [1.2334206751327104,
                                                                         1.3892140470260306,
                                                                         14.2443890625],
                                                            'symbol': 'Ni',
                                                            'tag': 0},
                                                           {'charge': 0.0,
                                                            'index': 16,
                                                            'magmom': 0.0,
                                                            'momentum': [0.0, 0.0, 0.0],
                                                            'position': [2.3533372736616487,
                                                                         4.547072866370334,
                                                                         19.5480374643452],
                                                            'symbol': 'H',
                                                            'tag': 1}],
                                                 'cell': [[5.05143668, 0.0, 0.0],
                                                          [-0.59803452, 5.01591141, 0.0],
                                                          [0.0, 0.0, 30.38803]],
                                                 'chemical_symbols': ['Ni', 'Al', 'H'],
                                                 'constraints': [{'kwargs': {'indices': [3,
                                                                                         4,
                                                                                         5,
                                                                                         11,
                                                                                         12,
                                                                                         13,
                                                                                         14,
                                                                                         15]},
                                                                  'name': 'FixAtoms'}],
                                                 'info': {},
                                                 'mass': 749.831231,
                                                 'natoms': 17,
                                                 'pbc': [True, True, True],
                                                 'spacegroup': 'P1 (1)',
                                                 'symbol_counts': {'Al': 6,
                                                                   'H': 1,
                                                                   'Ni': 10},
                                                 'volume': 769.958499375382},
                                       'calculator': {'class': 'SinglePointCalculator',
                                                      'module': 'ase.calculators.singlepoint'},
                                       'ctime': datetime.datetime(2017, 8, 22, 20, 37, 5, 299000),
                                       'inserted-hash': '6c11f64e7133f1c8d7ddfdca27d5fcc6d0cc25e2',
                                       'mtime': datetime.datetime(2017, 8, 22, 20, 37, 5, 299000),
                                       'results': {'energy': -76.41597574,
                                                   'fmax': 1.31878027,
                                                   'fmax_unconstrained': 1.31878027,
                                                   'forces': [[-0.02231178,
                                                               -0.02344649,
                                                               0.00389204],
                                                              [-0.09324877,
                                                               -0.28699652,
                                                               0.18745031],
                                                              [0.22890715,
                                                               0.038534,
                                                               0.14810798],
                                                              [0.0, 0.0, 0.0],
                                                              [0.0, 0.0, 0.0],
                                                              [0.0, 0.0, 0.0],
                                                              [0.06071606,
                                                               -0.00316198,
                                                               -0.08268006],
                                                              [-0.06806373,
                                                               0.0521918,
                                                               -0.08824136],
                                                              [-0.11684163,
                                                               0.10125742,
                                                               0.14136739],
                                                              [-0.26593377,
                                                               0.45293263,
                                                               1.17388733],
                                                              [-0.1769763,
                                                               0.13528569,
                                                               -0.20599833],
                                                              [0.0, 0.0, 0.0],
                                                              [0.0, 0.0, 0.0],
                                                              [0.0, 0.0, 0.0],
                                                              [0.0, 0.0, 0.0],
                                                              [0.0, 0.0, 0.0],
                                                              [0.46164604,
                                                               -0.47452865,
                                                               -1.31878027]]},
                                       'user': 'ktran'},
             'inserted-hash': '44164ae23e100630f54f72b18266f272dc726dbe',
             'mtime': datetime.datetime(2017, 8, 25, 12, 19, 23, 382000),
             'processed_data': {'FW_info': {'adslab_calculation_date': datetime.datetime(2017, 5, 16, 8, 56, 29, 993000),
                                            'bulk': 26145,
                                            'slab': 26513,
                                            'slab+adsorbate': 27948},
                                'calculation_info': {'adsorbate_names': ['H'],
                                                     'adsorbates': [{'adsorption_site': '[  '
                                                                                        '2.35   '
                                                                                        '4.55  '
                                                                                        '20.05]',
                                                                     'atoms': '63636f70795f7265670a5f7265636f6e7374727563746f720a70310a28636173652e61746f6d730a41746f6d730a70320a635f5f6275696c74696e5f5f0a6f626a6563740a70330a4e745270340a286470350a5327696e666f270a70360a286470370a7353275f63656c6c64697370270a70380a636e756d70792e636f72652e6d756c746961727261790a5f7265636f6e7374727563740a70390a28636e756d70790a6e6461727261790a7031300a2849300a74532762270a74527031310a2849310a2849330a49310a74636e756d70790a64747970650a7031320a2853276638270a49300a49310a74527031330a2849330a53273c270a4e4e4e492d310a492d310a49300a74624930300a53275c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c783030270a74627353275f63616c63270a7031340a4e735327617272617973270a7031350a28647031360a5327706f736974696f6e73270a7031370a67390a286731300a2849300a74532762270a74527031380a2849310a2849310a49330a746731330a4930300a53275c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7865305c786266270a74627353276e756d62657273270a7031390a67390a286731300a2849300a74532762270a74527032300a2849310a2849310a746731320a2853276938270a49300a49310a74527032310a2849330a53273c270a4e4e4e492d310a492d310a49300a74624930300a53275c7830315c7830305c7830305c7830305c7830305c7830305c7830305c783030270a7462737353275f706263270a7032320a67390a286731300a2849300a74532762270a74527032330a2849310a2849330a746731320a2853276231270a49300a49310a74527032340a2849330a53277c270a4e4e4e492d310a492d310a49300a74624930300a53275c7830305c7830305c783030270a74627353275f63656c6c270a7032350a67390a286731300a2849300a74532762270a74527032360a2849310a2849330a49330a746731330a4930300a53275c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c7830305c783030270a74627353275f636f6e73747261696e7473270a7032370a286c7032380a73622e',
                                                                     'name': 'H'}],
                                                     'formula': 'HAl6Ni10',
                                                     'miller': [0, 0, 1],
                                                     'mpid': 'mp-16514',
                                                     'num_slab_atoms': 0,
                                                     'relaxed': True,
                                                     'shift': 0,
                                                     'slabrepeat': '(1, 1)',
                                                     'top': True,
                                                     'type': 'slab+adsorbate'},
                                'fp_final': {'coordination': 'Al-Ni',
                                             'natoms': 17,
                                             'neighborcoord': ['Al:Ni-Ni-Ni-Ni-Ni-Ni-Ni',
                                                               'Ni:Al-Al-Al-Al-Al-Ni-Ni'],
                                             'nextnearestcoordination': 'Al-Al-Al-Al-Ni-Ni-Ni-Ni-Ni-Ni-Ni-Ni'},
                                'fp_init': {'coordination': 'Al-Al-Ni',
                                            'natoms': 17,
                                            'neighborcoord': ['Al:Al-Ni-Ni-Ni-Ni-Ni-Ni-Ni',
                                                              'Ni:Al-Al-Al-Al-Al-Ni-Ni-Ni-Ni',
                                                              'Al:Al-Ni-Ni-Ni-Ni-Ni-Ni-Ni'],
                                            'nextnearestcoordination': 'Al-Al-Al-Al-Ni-Ni-Ni-Ni-Ni-Ni-Ni-Ni'},
                                'movement_data': {'max_adsorbate_movement': 0.8457428560968356,
                                                  'max_bare_slab_movement': 0.0,
                                                  'max_surface_movement': 0.18339363315760085},
                                'vasp_settings': {'ediffg': -0.03,
                                                  'encut': 350,
                                                  'gga': 'RP',
                                                  'ibrion': 2,
                                                  'isif': 0,
                                                  'isym': 0,
                                                  'kpts': [4, 4, 1],
                                                  'lreal': 'Auto',
                                                  'nsw': 200,
                                                  'pp': 'PBE',
                                                  'pp_version': '5.4'}},
             'results': {'energy': -0.16585670499999816,
                         'fmax': 0.02042157,
                         'fmax_unconstrained': 0.02042157,
                         'forces': [[0.00306256, 0.00870758, 0.00381941],
                                    [-0.01105729, 0.01360587, 0.01472839],
                                    [0.01119062, 0.00483371, -0.0129477],
                                    [0.0, 0.0, 0.0],
                                    [0.0, 0.0, 0.0],
                                    [0.0, 0.0, 0.0],
                                    [0.00112023, 0.00663081, -0.01856812],
                                    [0.0071955, 0.01563725, -0.00506661],
                                    [-0.01261255, 0.00810186, 0.0046822],
                                    [-0.01359731, 0.01071098, -0.00354493],
                                    [0.00921017, 0.02042157, -0.00211493],
                                    [0.0, 0.0, 0.0],
                                    [0.0, 0.0, 0.0],
                                    [0.0, 0.0, 0.0],
                                    [0.0, 0.0, 0.0],
                                    [0.0, 0.0, 0.0],
                                    [-0.01116983, 0.01172566, 0.0032543]]},
             'user': 'zulissi'}]
    return docs


def test_get_adsorption_docs():
    expected_docs = get_expected_aggregated_adsorption_documents()
    docs = get_adsorption_docs(_collection_tag='for_unit_testing')
    assert docs == expected_docs


def get_expected_aggregated_adsorption_documents():
    '''
    Note that we have only one document because the other one should have been filtered out.
    '''
    docs = [{'adslab_calculation_date': datetime.datetime(2017, 5, 16, 8, 56, 29, 993000),
             'adsorbates': ['H'],
             'coordination': 'Al-Ni',
             'energy': -0.16585670499999816,
             'formula': 'HAl6Ni10',
             'miller': [0, 0, 1],
             'mongo_id': ObjectId('59a015cbd3952577173b122d'),
             'mpid': 'mp-16514',
             'neighborcoord': ['Al:Ni-Ni-Ni-Ni-Ni-Ni-Ni', 'Ni:Al-Al-Al-Al-Al-Ni-Ni'],
             'nextnearestcoordination': 'Al-Al-Al-Al-Ni-Ni-Ni-Ni-Ni-Ni-Ni-Ni',
             'shift': 0,
             'top': True}]
    return docs


def test__clean_up_aggregated_docs():
    expected_docs = get_expected_collection_documents()
    dirty_docs = __make_documents_dirty(expected_docs)
    clean_docs = _clean_up_aggregated_docs(dirty_docs, expected_keys=expected_docs[0].keys())
    assert _compare_unordered_sequences(clean_docs, expected_docs)


def _compare_unordered_sequences(seq0, seq1):
    '''
    If (1) we want to see if two sequences are identical, (2) do not care about ordering,
    (3) the items are not hashable, and (4) items are not orderable, then use this
    function to compare them. Credit goes to CrowbarKZ on StackOverflow.
    '''
    seq0 = list(seq0)   # make a mutable copy
    try:
        for element in seq1:
            seq0.remove(element)
    except ValueError:
        return False
    return not seq0


def __make_documents_dirty(docs):
    ''' Helper function for `test__clean_up_docs`  '''
    # Make a document with a missing key/value item
    doc_partial = copy.deepcopy(random.choice(docs))
    key_to_delete = random.choice(list(doc_partial.keys()))
    _ = doc_partial.pop(key_to_delete)   # noqa: F841

    # Make a document with a `None` value
    doc_empty = copy.deepcopy(random.choice(docs))
    key_to_modify = random.choice(list(doc_empty.keys()))
    doc_empty[key_to_modify] = None

    # Make the dirty documents
    dirty_docs = copy.deepcopy(docs) + [doc_partial] + [doc_empty]
    dirty_docs = [{'_id': doc} for doc in dirty_docs]   # because mongo is stupid
    return dirty_docs


def test_hash_docs():
    assert 1 == 0


def test_hash_doc():
    assert 1 == 0
